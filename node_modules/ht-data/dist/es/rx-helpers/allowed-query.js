var __assign = (this && this.__assign) || Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
        s = arguments[i];
        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
            t[p] = s[p];
    }
    return t;
};
import { distinctUntilChanged, filter, map, scan } from "rxjs/operators";
import { combineLatest } from "rxjs/observable/combineLatest";
import { of } from "rxjs/observable/of";
export var AllowedQueryKeys$ = function (allowedQueryKeys) {
    return function (queryStore$) {
        if (allowedQueryKeys && allowedQueryKeys.length) {
            var keys$ = allowedQueryKeys.map(function (key) {
                return queryStore$.pipe(map(function (store) { return (store ? store[key] : null); }), distinctUntilChanged(), map(function (value) {
                    return value ? (_a = {}, _a[key] = value, _a) : null;
                    var _a;
                }));
            });
            return combineLatest.apply(void 0, keys$).pipe(map(function (obsArray) {
                console.log(obsArray, "arr");
                return obsArray.reduce(function (acc, query) {
                    return query ? __assign({}, acc, query) : acc;
                }, {});
            }));
        }
        else if (allowedQueryKeys) {
            return of({});
        }
        else {
            return queryStore$;
        }
    };
};
export var AllowedQueryMap = function (allowedQueryMaps) {
    return function (queryStore$) {
        if (allowedQueryMaps && allowedQueryMaps.length) {
            var keys$ = allowedQueryMaps.map(function (queryMap) {
                return queryStore$.pipe(map(function (store) { return (store ? store[queryMap.key] : null); }), scan(function (acc, value) {
                    return { value: value, oldValue: acc.value };
                }, { value: "_no_val", oldValue: "_" }), filter(function (obj) {
                    if (obj.oldValue == "_no_val") {
                        return true;
                    }
                    else if (!obj.oldValue || !obj.value) {
                        return false;
                    }
                    else if (obj.oldValue == obj.value) {
                        return false; //distinct unntil changed
                    }
                    else if (queryMap.filter) {
                        return queryMap.filter(obj.value, obj.oldValue);
                    }
                    else {
                        return true;
                    }
                }), map(function (obj) {
                    return obj.value ? (_a = {}, _a[queryMap.key] = obj.value, _a) : null;
                    var _a;
                }));
            });
            return combineLatest.apply(void 0, keys$).pipe(map(function (obsArray) {
                // console.log(obsArray, "arr");
                return obsArray.reduce(function (acc, query) {
                    return query ? __assign({}, acc, query) : acc;
                }, {});
            }));
            // return queryStore$
        }
        else if (allowedQueryMaps) {
            return of({});
        }
        else {
            return queryStore$;
        }
    };
};
//# sourceMappingURL=allowed-query.js.map